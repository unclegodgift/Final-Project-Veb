<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тестирование</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="container">
            <a href="index.html" class="logo">TESTio</a>
        </div>
    </header>

    <main class="main">
        <div class="container test-container">
            <h1 class="test-title" id="testTitle"></h1>
            <p class="test-description" id="testDescription"></p>
            
            <div class="progress-section">
                <div class="progress-header">
                    <span>Прогресс</span>
                    <span class="timer">
                        <svg class="timer-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <span id="timeLeft">00:00</span> осталось
                    </span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <div class="question-card" id="questionCard">
                <!-- Вопрос будет загружен здесь -->
            </div>

            <div class="test-navigation">
                <button class="btn btn-outline" id="prevBtn" onclick="handlePrev()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Назад
                </button>
                <button class="btn btn-primary" id="nextBtn" onclick="handleNext()">
                    Далее
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </button>
                <button class="btn btn-primary" id="submitBtn" onclick="handleSubmit()" style="display: none;">
                    Завершить тест
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 6L9 17l-5-5"/>
                    </svg>
                </button>
            </div>
        </div>
    </main>

    <!-- Диалог при завершении времени -->
    <div class="dialog-overlay" id="timeoutDialog" style="display: none;">
        <div class="dialog">
            <div class="dialog-header">
                <h2 class="dialog-title">Время вышло!</h2>
                <p class="dialog-description">Время для прохождения теста истекло. Ваши ответы будут отправлены автоматически.</p>
            </div>
            <div class="dialog-footer">
                <button class="btn btn-primary" onclick="handleTimeoutSubmit()">Посмотреть результаты</button>
            </div>
        </div>
    </div>

    <script src="js/data.js"></script>
    <script src="js/app.js"></script>
    <script>
        let currentTest = null;
        let currentQuestionIndex = 0;
        let answers = {};
        let timeLeft = 0;
        let timerInterval = null;

        document.addEventListener('DOMContentLoaded', function() {
            const testId = new URLSearchParams(window.location.search).get('id');
            if (!testId) {
                window.location.href = 'index.html';
                return;
            }

            currentTest = tests.find(t => t.id === testId);
            if (!currentTest) {
                window.location.href = 'index.html';
                return;
            }

            // Очистить предыдущие ответы
            localStorage.removeItem(`3dtest-answers-${testId}`);

            // Инициализация теста
            timeLeft = currentTest.timeLimit * 60;
            document.getElementById('testTitle').textContent = currentTest.title;
            document.getElementById('testDescription').textContent = currentTest.description;
            
            loadQuestion();
            startTimer();
        });

        function startTimer() {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    document.getElementById('timeoutDialog').style.display = 'flex';
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timeLeft').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function loadQuestion() {
            const question = currentTest.questions[currentQuestionIndex];
            const questionCard = document.getElementById('questionCard');
            
            // Обновить прогресс
            const progress = ((currentQuestionIndex + 1) / currentTest.questions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        
            // Создать HTML вопроса
            let questionHTML = `
                <div class="question-header">
                    <span class="question-number">Вопрос ${currentQuestionIndex + 1}</span>
                    <h2 class="question-text">${question.text}</h2>
                </div>
                <div class="question-content">
            `;
        
            // Добавляем блок с картинкой ТОЛЬКО если есть изображение
            if (question.image) {
                questionHTML += `
                    <div class="question-image-container">
                        <img src="${question.image}" alt="Иллюстрация к вопросу" class="question-image" 
                             onerror="this.style.display='none'; this.parentElement.style.display='none';">
                    </div>
                `;
            }
        
            if (question.type === 'multiple-choice') {
                questionHTML += '<div class="radio-group">';
                question.options.forEach(option => {
                    const isChecked = answers[question.id] === option ? 'checked' : '';
                    questionHTML += `
                        <label class="radio-label">
                            <input type="radio" name="question-${question.id}" value="${option}" ${isChecked} 
                                   onchange="handleAnswerChange('${question.id}', '${option}')">
                            <span>${option}</span>
                        </label>
                    `;
                });
                questionHTML += '</div>';
            } else if (question.type === 'true-false') {
                questionHTML += '<div class="radio-group">';
                ['Верно', 'Неверно'].forEach(value => {
                    const isChecked = answers[question.id] === value ? 'checked' : '';
                    questionHTML += `
                        <label class="radio-label">
                            <input type="radio" name="question-${question.id}" value="${value}" ${isChecked}
                                   onchange="handleAnswerChange('${question.id}', '${value}')">
                            <span>${value}</span>
                        </label>
                    `;
                });
                questionHTML += '</div>';
            } else if (question.type === 'fill-in-the-blank') {
                questionHTML += `
                    <input type="text" class="input" placeholder="Введите ваш ответ..." 
                           value="${answers[question.id] || ''}"
                           onchange="handleAnswerChange('${question.id}', this.value)">
                `;
            }
        
            questionHTML += '</div>';
            questionCard.innerHTML = questionHTML;
        
            // Обновить кнопки навигации
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            if (currentQuestionIndex === currentTest.questions.length - 1) {
                document.getElementById('nextBtn').style.display = 'none';
                document.getElementById('submitBtn').style.display = 'flex';
            } else {
                document.getElementById('nextBtn').style.display = 'flex';
                document.getElementById('submitBtn').style.display = 'none';
            }
        }

        function handleAnswerChange(questionId, value) {
            answers[questionId] = value;
        }

        function handleNext() {
            if (currentQuestionIndex < currentTest.questions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            }
        }

        function handlePrev() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        }

        function handleSubmit() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            localStorage.setItem(`3dtest-answers-${currentTest.id}`, JSON.stringify(answers));
            window.location.href = `results.html?id=${currentTest.id}`;
        }

        function handleTimeoutSubmit() {
            document.getElementById('timeoutDialog').style.display = 'none';
            handleSubmit();
        }
    </script>
</body>

</html>

