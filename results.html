<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Результаты - Платформа 3DТесты</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="container">
            <a href="index.html" class="logo">3DТесты</a>
        </div>
    </header>

    <main class="main">
        <div class="container results-container">
            <div class="results-card">
                <div class="results-header">
                    <h1 class="results-title">Результаты теста</h1>
                    <p class="results-subtitle" id="resultsSubtitle"></p>
                </div>
                <div class="results-content">
                    <p class="results-score" id="resultsScore">0%</p>
                    <p class="results-summary" id="resultsSummary"></p>
                </div>
                <div class="results-actions">
                    <a href="index.html" class="btn btn-outline">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                        На главную
                    </a>
                    <button class="btn btn-primary" onclick="retakeTest()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                        </svg>
                        Пройти снова
                    </button>
                </div>
            </div>

            <h2 class="breakdown-title">Разбор ответов</h2>
            <div class="breakdown-list" id="breakdownList">
                <!-- Разбор ответов будет загружен здесь -->
            </div>
        </div>
    </main>

    <script src="js/data.js"></script>
    <script src="js/app.js"></script>
    <script>
        let currentTest = null;
        let answers = {};

        document.addEventListener('DOMContentLoaded', function() {
            const testId = new URLSearchParams(window.location.search).get('id');
            if (!testId) {
                window.location.href = 'index.html';
                return;
            }

            currentTest = tests.find(t => t.id === testId);
            if (!currentTest) {
                window.location.href = 'index.html';
                return;
            }

            const storedAnswers = localStorage.getItem(`3dtest-answers-${testId}`);
            if (storedAnswers) {
                answers = JSON.parse(storedAnswers);
            }

            calculateResults();
            displayBreakdown();
        });

        function calculateResults() {
            let correct = 0;
            
            currentTest.questions.forEach(question => {
                const userAnswer = (answers[question.id] || '').toString().trim().toLowerCase();
                
                // Обрабатываем правильный ответ
                let correctAnswer;
                if (Array.isArray(question.correctAnswer)) {
                    correctAnswer = question.correctAnswer.map(answer => answer.toString().trim().toLowerCase());
                } else {
                    correctAnswer = [question.correctAnswer.toString().trim().toLowerCase()];
                }
                
                // Проверяем ответ пользователя
                if (userAnswer && correctAnswer.includes(userAnswer)) {
                    correct++;
                }
            });

            const score = Math.round((correct / currentTest.questions.length) * 100);
            
            document.getElementById('resultsSubtitle').textContent = `Результаты теста: ${currentTest.title}`;
            document.getElementById('resultsScore').textContent = `${score}%`;
            document.getElementById('resultsSummary').textContent = 
                `Вы ответили правильно на ${correct} из ${currentTest.questions.length} вопросов.`;
        }

        function displayBreakdown() {
            const breakdownList = document.getElementById('breakdownList');
            breakdownList.innerHTML = '';

            currentTest.questions.forEach((question, index) => {
                const userAnswer = answers[question.id] || 'Нет ответа';
                const correctAnswer = Array.isArray(question.correctAnswer)
                    ? question.correctAnswer.join(' или ')
                    : question.correctAnswer;
                
                const userAnswerLower = userAnswer.toString().toLowerCase();
                const correctAnswerLower = Array.isArray(question.correctAnswer)
                    ? question.correctAnswer.map(a => a.toString().toLowerCase())
                    : [question.correctAnswer.toString().toLowerCase()];
                
                const isCorrect = correctAnswerLower.includes(userAnswerLower);

                // Создаем HTML для картинки
                let imageHTML = '';
                if (question.image) {
                    imageHTML = `
                        <div class="breakdown-image-container">
                            <img src="${question.image}" alt="Иллюстрация" class="breakdown-image" 
                                 onerror="this.style.display='none'; this.parentElement.querySelector('.image-placeholder').style.display='flex';">
                            <div class="image-placeholder small" style="display: none;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                            </div>
                        </div>
                    `;
                } else {
                    imageHTML = `
                        <div class="breakdown-image-container">
                            <div class="image-placeholder small">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                            </div>
                        </div>
                    `;
                }

                const questionCard = document.createElement('div');
                questionCard.className = `breakdown-card ${isCorrect ? 'correct' : 'incorrect'}`;
                
                questionCard.innerHTML = `
                    <div class="breakdown-card-header">
                        <h3 class="breakdown-card-title">Вопрос ${index + 1}</h3>
                        <p class="breakdown-card-text">${question.text}</p>
                    </div>
                    ${imageHTML}
                    <div class="breakdown-card-content">
                        <div class="breakdown-answer">
                            <span class="breakdown-label">Ваш ответ:</span>
                            <span class="breakdown-value ${isCorrect ? 'correct' : 'incorrect'}">
                                ${userAnswer}
                                ${isCorrect 
                                    ? '<svg class="breakdown-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>'
                                    : '<svg class="breakdown-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>'
                                }
                            </span>
                        </div>
                        ${!isCorrect ? `
                            <div class="breakdown-answer">
                                <span class="breakdown-label">Правильный ответ:</span>
                                <span class="breakdown-value">${correctAnswer}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                breakdownList.appendChild(questionCard);
            });
        }

        function retakeTest() {
            window.location.href = `test.html?id=${currentTest.id}`;
        }
    </script>
</body>
</html>